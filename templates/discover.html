<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>—Å–∫–∞M - –û—Ç–∫—Ä—ã—Ç–∏—è</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .discover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .discover-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .discover-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
        }
        
        .create-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: var(--secondary-color);
            color: white;
            cursor: pointer;
        }
        
        .tab-button.active {
            background: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="{{ 'dark-theme' if session.get('dark_theme') else '' }}">
    
    <div class="theme-toggle">
        <label class="theme-switch">
            <input type="checkbox" id="themeCheckbox" {{ 'checked' if session.get('dark_theme') else '' }}>
            <span class="slider">
                <div class="theme-icons">
                    <span class="theme-icon sun">‚òÄÔ∏è</span>
                    <span class="theme-icon moon">üåô</span>
                </div>
            </span>
        </label>
    </div>

    <div class="container">
        <header class="dashboard-header">
            <h1>–û—Ç–∫—Ä—ã—Ç–∏—è</h1>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
            </div>
        </header>

        <div class="create-section">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ</h2>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('group-tab')">–ì—Ä—É–ø–ø–∞</button>
                <button class="tab-button" onclick="showTab('channel-tab')">–ö–∞–Ω–∞–ª</button>
            </div>

            <div id="group-tab" class="tab-content active">
                <form id="createGroupForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã:</label>
                        <img id="groupAvatarPreview" src="{{ url_for('static', filename='group_avatars/default.jpg') }}" 
                             class="discover-avatar" style="cursor: pointer;" onclick="document.getElementById('groupAvatar').click()">
                        <input type="file" id="groupAvatar" name="avatar" accept="image/*" style="display: none;" onchange="previewGroupAvatar(event)">
                        <input type="hidden" id="groupAvatarData" name="avatar">
                    </div>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea name="description" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <input type="text" name="members" placeholder="username1, username2, username3">
                        <small>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è</small>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                </form>
            </div>

            <div id="channel-tab" class="tab-content">
                <form id="createChannelForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>–ê–≤–∞—Ç–∞—Ä –∫–∞–Ω–∞–ª–∞:</label>
                        <img id="channelAvatarPreview" src="{{ url_for('static', filename='group_avatars/default.jpg') }}" 
                             class="discover-avatar" style="cursor: pointer;" onclick="document.getElementById('channelAvatar').click()">
                        <input type="file" id="channelAvatar" name="avatar" accept="image/*" style="display: none;" onchange="previewChannelAvatar(event)">
                        <input type="hidden" id="channelAvatarData" name="avatar">
                    </div>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea name="description" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–∞–Ω–∞–ª..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_public" value="true" checked>
                            –ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                </form>
            </div>
        </div>

        <div class="users-list">
            <h2>–ü—É–±–ª–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã</h2>
            {% if public_groups %}
                <div class="discover-grid">
                    {% for group_id, group in public_groups.items() %}
                    <div class="discover-card">
                        <img src="{{ url_for('static', filename=group.avatar) }}" class="discover-avatar">
                        <h3>{{ group.name }}</h3>
                        <p>{{ group.description }}</p>
                        <p><small>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ group.members|length }}</small></p>
                        <button class="btn btn-primary" onclick="joinGroup('{{ group_id }}')">–í—Å—Ç—É–ø–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø</p>
            {% endif %}
        </div>

        <div class="users-list">
            <h2>–ü—É–±–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</h2>
            {% if public_channels %}
                <div class="discover-grid">
                    {% for channel_id, channel in public_channels.items() %}
                    <div class="discover-card">
                        <img src="{{ url_for('static', filename=channel.avatar) }}" class="discover-avatar">
                        <h3>{{ channel.name }}</h3>
                        <p>{{ channel.description }}</p>
                        <p><small>–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {{ channel.subscribers|length }}</small></p>
                        <button class="btn btn-primary" onclick="subscribeChannel('{{ channel_id }}')">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤</p>
            {% endif %}
        </div>
    </div>

    <script>
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function previewGroupAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('groupAvatarPreview').src = e.target.result;
                    document.getElementById('groupAvatarData').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewChannelAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('channelAvatarPreview').src = e.target.result;
                    document.getElementById('channelAvatarData').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('createGroupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const membersInput = this.querySelector('input[name="members"]');
            if (membersInput.value.trim()) {
                const members = membersInput.value.split(',').map(m => m.trim()).filter(m => m);
                members.forEach(member => {
                    formData.append('members', member);
                });
            }
            
            fetch('/create_group', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    window.location.href = '/dashboard';
                } else {
                    alert(data.message);
                }
            });
        });

        document.getElementById('createChannelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/create_channel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω!');
                    window.location.href = '/dashboard';
                } else {
                    alert(data.message);
                }
            });
        });

        function joinGroup(groupId) {
            const formData = new FormData();
            formData.append('group_id', groupId);
            
            fetch('/join_group', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É!');
                    window.location.href = '/dashboard';
                } else {
                    alert(data.message);
                }
            });
        }

        function subscribeChannel(channelId) {
            const formData = new FormData();
            formData.append('channel_id', channelId);
            
            fetch('/subscribe_channel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª!');
                    window.location.href = '/dashboard';
                } else {
                    alert(data.message);
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        document.getElementById('themeCheckbox').addEventListener('change', function() {
            fetch('/toggle_theme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({dark_theme: this.checked})
            }).then(() => location.reload());
        });
    </script>
</body>
</html>